name: terraform
on:
  push:
    branches:
      - master
jobs:
  terraform:
    runs-on: ubuntu-latest
    env:
      TF_version: latest
      TF_working_dir: './terraform/'
      TF_VAR_digitalocean_api_token: ${{ secrets.DIGITALOCEAN_API_TOKEN }}
      TF_VAR_digitalocean_public_ssh_key_name: ${{ secrets.DIGITALOCEAN_PUBLIC_SSH_KEY_NAME }}
    steps:
      - name: env TF_VAR_digitalocean_instance_name
        run: echo ::set-env name=TF_VAR_digitalocean_instance_name::${GITHUB_REPOSITORY#*/}-${GITHUB_SHA:0:7}
      - name: checkout
        uses: actions/checkout@master
      - name: terraform fmt
        uses: hashicorp/terraform-github-actions@master
        with:
          tf_actions_version: ${{ env.TF_version }}
          tf_actions_working_dir: ${{ env.TF_working_dir }}
          tf_actions_subcommand: fmt
      - name: terraform init
        uses: hashicorp/terraform-github-actions@master
        with:
          tf_actions_version: ${{ env.TF_version }}
          tf_actions_working_dir: ${{ env.TF_working_dir }}
          tf_actions_subcommand: init
      - name: terraform validate
        uses: hashicorp/terraform-github-actions@master
        with:
          tf_actions_version: ${{ env.TF_version }}
          tf_actions_working_dir: ${{ env.TF_working_dir }}
          tf_actions_subcommand: validate
      - name: terraform plan
        uses: hashicorp/terraform-github-actions@master
        with:
          tf_actions_version: ${{ env.TF_version }}
          tf_actions_working_dir: ${{ env.TF_working_dir }}
          tf_actions_subcommand: plan